(function(){var e;e="undefined"!=typeof exports&&null!==exports?exports:this,e.genTangle=function(e,t,n){var r;return r=new Tangle($(e).get(0),{initialize:function(){var e=this;return _.each(t,function(t,n){return e[n]=t})},update:n})}}).call(this),function(){var e,t,n,r;e="undefined"!=typeof exports&&null!==exports?exports:this,r={},r.adjustLiteral=function(e,t){return"value"===e&&_.isRegExp(t)?""+t:_.isArray(t)&&_.all(t,function(e){return!_.isObject(e)})?"["+t.join(" ")+"]":t},r.printJSON=function(e){var t;return t=JSON.stringify(e,r.adjustLiteral,4),t.replace(/['"]/g,"")},r.convertLoc=function(e){return{line:e.line-1,column:e.ch||e.column}},r.toLoc=function(e,t){return{line:e,ch:t}},r.withinRange=function(e,t){return null!=t&&2===t.length&&e>=t[0]&&t[1]>=e},r.toHex=function(e,t){var n,r,i,o;for(n=Math.floor(e).toString(16),null==t&&(t=n.length),r=i=0,o=t-n.length;o>=0?o>i:i>o;r=o>=0?++i:--i)n="0"+n;return n.slice(-t)},r.mapValue=function(e,t,n){var r;return r=n-t,e*r+t},r.insertHelpers=function(e,t,n,r){return e.range?(e.depth=r,e.parent=t,e.source=function(){return n.slice(e.range[0],e.range[1]).join("")},e.updateSource=function(t){var r,i,o,a;for(n[e.range[0]]=t,r=i=o=e.range[0]+1,a=e.range[1];a>=o?a>i:i>a;r=a>=o?++i:--i)n[r]="";return t},e.insertBefore=function(t){return n[e.range[0]]=t+"\n"+n[e.range[0]],t},e.insertAfter=function(t){var r;return r=e.range[1]-1,n[r]=n[r]+"\n"+t,t},e):void 0},r.traverse=function(e,t,n,r){var i,o=this;return i=function(e,a,s){return null==s&&(s=0),null!=r&&r.call(o,e,a,t,s),_.each(e,function(n,a){return"parent"!==a&&"range"!==a&&"loc"!==a?_.isArray(n)?_.each(n,function(t){return t&&"string"==typeof t.type?i(t,e,s+1):void 0}):null!=n&&"string"==typeof n.type?(null!=r&&r.call(o,n,e,t,s),i(n,e,s)):void 0:void 0}),null!=n?n.call(o,e,a,t):void 0},i(e)},r.scopeLookup=function(e,t){var n,r;for(n=e;null!=n&&(r=_.find(t,function(e){return e.node===n}),null==r);)n=n.parent;return r||t.global},r.scopeName=function(e,t){var n;return n="global"===t.name?"":t.name+".",n+e},r.unscopeName=function(e){return e.split(".").slice(-1)[0]},r.objGet=function(e,t){var n;for(n=t.split(".");n.length&&null!=e;)e=e[n.shift()];return e},r.objSet=function(e,t,n){var r,i;for(i=t.split(".");i.length>1;)r=i.shift(),e[r]=e[r]||{},e=e[r];return e[i[0]]=n},t=function(e){return _.all(e,function(t){return t===e[0]})},n=function(e,n){return function(i,o){var a,s;return a=e+"  ",_.isArray(i)?t(i)?a+=o+":	"+JSON.stringify(i[0]):(s=_.map(i,function(e){return JSON.stringify(e)}),a+=o+":	"+s.join(" | ")):a+=_.isObject(i)?o+":	"+r.formatVarJSON(i,n+1):o+":	"+i,a}},r.formatVal=n("",0),r.formatVarJSON=function(e,t){var r,i,o;return null==t&&(t=0),o=function(){var e,n;for(n=[],i=e=0;t>=0?t>=e:e>=t;i=t>=0?++e:--e)n.push("  ");return n}().join(""),r=_.map(e,n(o,t)),"{\n"+r.join(",\n")+("\n"+o+"}")},r.getParameterByName=function(e){var t,n,r;return e=e.replace(/[\[]/,"\\[").replace(/[\]]/,"\\]"),n="[\\?&]"+e+"=([^&#]*)",t=RegExp(n),r=t.exec(window.location.search),null!=r?decodeURIComponent(r[1].replace(/\+/g," ")):void 0},e.util=r}.call(this),function(){var e;e="undefined"!=typeof exports&&null!==exports?exports:this,e.Syntax={AssignmentExpression:"AssignmentExpression",ArrayExpression:"ArrayExpression",BlockStatement:"BlockStatement",BinaryExpression:"BinaryExpression",BreakStatement:"BreakStatement",CallExpression:"CallExpression",CatchClause:"CatchClause",ConditionalExpression:"ConditionalExpression",ContinueStatement:"ContinueStatement",DoWhileStatement:"DoWhileStatement",DebuggerStatement:"DebuggerStatement",EmptyStatement:"EmptyStatement",ExpressionStatement:"ExpressionStatement",ForStatement:"ForStatement",ForInStatement:"ForInStatement",FunctionDeclaration:"FunctionDeclaration",FunctionExpression:"FunctionExpression",Identifier:"Identifier",IfStatement:"IfStatement",Literal:"Literal",LabeledStatement:"LabeledStatement",LogicalExpression:"LogicalExpression",MemberExpression:"MemberExpression",NewExpression:"NewExpression",ObjectExpression:"ObjectExpression",Program:"Program",Property:"Property",ReturnStatement:"ReturnStatement",SequenceExpression:"SequenceExpression",SwitchStatement:"SwitchStatement",SwitchCase:"SwitchCase",ThisExpression:"ThisExpression",ThrowStatement:"ThrowStatement",TryStatement:"TryStatement",UnaryExpression:"UnaryExpression",UpdateExpression:"UpdateExpression",VariableDeclaration:"VariableDeclaration",VariableDeclarator:"VariableDeclarator",WhileStatement:"WhileStatement",WithStatement:"WithStatement"}}.call(this),function(){var e,t;e="undefined"!=typeof exports&&null!==exports?exports:this,t={active:!1,funcDict:{},varDict:{},varLocDict:{},statementList:[],reset:function(){return this.funcDict={},this.statementList=[],this.varDict={},this.varLocDict={}},genTraces:function(e,t){var n,r,i,o,a,s,l,u,c,f,h,p,d,m,g,v,y,b,x,w,S;for(this.reset(),S=[],g=0,y=e.length;y>g;g++){switch(i=e[g],p=util.scopeLookup(i,t),l=i.loc,d="",a="Before",i.type){case Syntax.FunctionExpression:case Syntax.FunctionDeclaration:u={name:i.name,range:i.range,loc:l},d+=window.tracer.genTraceFunc(u),null!=i.body&&i.body.length?i=i.body[0]:null!=i.body.body&&i.body.body.length&&(i=i.body.body[0]);break;case Syntax.ForStatement:d+=window.tracer.genTraceStatement({loc:l,data:{init:i.init&&i.init.source(),test:i.test.source(),update:i.update.source()}}),i=i.body.body[0];break;case Syntax.VariableDeclaration:for(d+=window.tracer.genTraceStatement({loc:l}),x=i.declarations,v=0,b=x.length;b>v;v++)m=x[v],d+=window.tracer.genTraceVar(l,m.id.name,p),a="After";null==i.parent||(w=i.parent.type)!==Syntax.ForStatement&&w!==Syntax.ForInStatement||(i=i.parent.body.body[0],a="Before");break;case Syntax.ForInStatement:s=i.left,h=i.right,d+=window.tracer.genTraceStatement({loc:l,data:{left:s.source(),right:h.source()}}),s.type===Syntax.Identifier&&(d+=window.tracer.genTraceVar(l,s.name,p)),i=i.body.body[0];break;case Syntax.ExpressionStatement:switch(o=i.expression,c=o.parent,r={},o.type){case Syntax.CallExpression:r.callee=o.callee.source(),r.arguments=function(){var e,t,r,i;for(r=o.arguments,i=[],e=0,t=r.length;t>e;e++)n=r[e],i.push(n.source());return i}();break;case Syntax.AssignmentExpression:switch(r.left=o.left.source(),r.right=o.right.source(),a="After",o.left.type){case Syntax.Identifier:d+=window.tracer.genTraceVar(l,o.left.name,p);break;case Syntax.MemberExpression:d+=window.tracer.genTraceVar(l,o.left.object.name,p)}}d+=window.tracer.genTraceStatement({loc:l,data:r,scope:p});break;case Syntax.ReturnStatement:d+=window.tracer.genTraceStatement({loc:l,scope:p}),f=null!=i.argument?i.argument.source():"null",d+=window.tracer.genTraceVar(l,"return",p,f)}S.push(i["insert"+a](d))}return S},genTraceFunc:function(e){var t;return t=JSON.stringify(e),"window.tracer.traceFunc("+t+");"},genTraceVar:function(e,t,n,r){var i;return null==r&&(r=t),i=util.scopeName(t,n),"window.tracer.traceVar("+JSON.stringify(e)+", '"+i+"', "+r+");"},genTraceStatement:function(e){var t,n;return n=e.scope,t=JSON.stringify(_.omit(e,"scope")),"window.tracer.traceStatement("+t+");"},traceVar:function(e,n,r){var i,o;return i=e.start.line-1,o=""+n+".all",null==util.objGet(t.varDict,o)&&util.objSet(t.varDict,o,[]),util.objGet(t.varDict,o).push(_.clone(r)),t.varLocDict[o]=n},toIndexMap:function(e){var t=this;return _.reduce(e,function(e,n,r){return e[r]=_.isArray(n)?n.length-1:t.toIndexMap(n),e},{})},traceStatement:function(e){return t.statementList.push(_.extend(e,{vars:this.toIndexMap(this.varDict),varLocs:_.cloneDeep(this.varLocDict)}))},indexMapToVarDict:function(e,t){var n=this;return null==t&&(t=""),_.reduce(e,function(e,r,i){var o;return o=""+t+i,e[i]=_.isObject(r)?n.indexMapToVarDict(r,""+o+"."):util.objGet(n.varDict,""+o+"."+r),e},{})},traceFunc:function(e){var n;if(t.active)return n=e.name,t.funcDict[n]?t.funcDict[n]+=1:t.funcDict[n]=1},funcHistogram:function(){var e;return e=_.clone(t.funcDict),t.funcDict={},e},getStatementList:function(){var e;return e=_.clone(t.statementList),t.statementList=[],e},getVars:function(){var e,t;return t=_.clone(this.varDict),this.varDict={},e=_.clone(this.varLocDict),this.varLocDict={},{vars:t,varLocs:e}}},e.tracer=t}.call(this),function(){var e,t;e="undefined"!=typeof exports&&null!==exports?exports:this,t={Alt:18,LeftSuper:91,RightSuper:93},e.Keys=t}.call(this),function(){var e;e="undefined"!=typeof exports&&null!==exports?exports:this,e.inventingOnPrinciple={Models:{},Collections:{},Views:{},Routers:{},Templates:{},Options:{max:200},init:function(){return this.model=new inventingOnPrinciple.Models.ApplicationModel,this.view=new inventingOnPrinciple.Views.ApplicationView({el:"#main",model:this.model})},getTemplate:function(e){return inventingOnPrinciple.Templates[e]}},$(function(){var e,t,n,r,i,o;inventingOnPrinciple.init();try{inventingOnPrinciple.codeEditor=CodeMirror.fromTextArea(document.getElementById("code"),{lineNumbers:!0,matchBrackets:!0}),inventingOnPrinciple.codeEditor.on("scroll",function(e){return inventingOnPrinciple.view.scrollVars(e.getScrollInfo())}),inventingOnPrinciple.codeEditor.on("cursorActivity",function(e){return inventingOnPrinciple.view.trackCursor(e)}),inventingOnPrinciple.codeEditor.on("change",function(e,t){return inventingOnPrinciple.view.parse(e,t)}),t=null!=(o=util.getParameterByName("f"))?o:"source4",$.get("/inventing-on-principle/scripts/"+t+".txt",function(e){return inventingOnPrinciple.codeEditor.setValue(e)},"text")}catch(a){console.log(a),console.log("CodeMirror failed to initialize")}return inventingOnPrinciple.view.parse(),e=$("#console"),window.log=function(t){var n;return n=e.html(),n+=t+" ",e.html(n),e.scrollTop(e[0].scrollHeight-e.height())},window.genTangle("span[data-container=max]",inventingOnPrinciple.Options,function(){return inventingOnPrinciple.Options.max=this.max,inventingOnPrinciple.view.parse()}),i=n=450,r=d3.select("#tab_d3").append("svg").attr("width",i).attr("height",n),window.initD3=_.once(function(e){var t,o,a,s,l,u;return a=_.pluck(e,"0"),l=_.pluck(e,"1"),o=i/e.length/2,t=4*o,s=d3.scale.linear().domain([_.min(a),_.max(a)]).range([t,i-t]),u=d3.scale.linear().domain([_.min(l),_.max(l)]).range([t,n-t]),window.xf=function(e){return s(e[0])},window.yf=function(e){return u(e[1])},r.selectAll("circle").data(e).enter().append("circle").attr("cx",xf).attr("cy",yf).attr("r",o),r.selectAll("text").data(e).text(function(e){return"("+e[0]+","+e[1]+")"}).attr("x",xf).attr("y",yf)}),window.updateD3=function(e){return window.initD3(e),r.selectAll("circle").data(e).attr("cx",xf).attr("cy",yf),r.selectAll("text").data(e).text(function(e){return"("+e[0]+","+e[1]+")"}).attr("x",xf).attr("y",yf)}})}.call(this),this.inventingOnPrinciple=this.inventingOnPrinciple||{},this.inventingOnPrinciple.Templates=this.inventingOnPrinciple.Templates||{},this.inventingOnPrinciple.Templates["function"]=function(obj){obj||(obj={});var __t,__p="";with(_.escape,obj)__p+=(null==(__t=inventingOnPrinciple.getTemplate("tab")(arguments[0].depth))?"":__t)+'\n<span class="funDec">\n    <span class="cm-keyword">function</span>\n    <span class="cm-variable-2">'+(null==(__t=id.name)?"":__t)+'</span>\n    <span class="cm-variable">\n    (\n        '+(null==(__t=_.map(_.pluck(params,"name"),function(e){return'<span class="cm-def">'+e+"</span>"}).join(", "))?"":__t)+"\n    )\n    </span>\n</span>";return __p},this.inventingOnPrinciple.Templates.hint=function(obj){obj||(obj={});var __t,__p="";with(_.escape,obj)__p+='<div class="alert alert-error">\n    <span class="message">'+(null==(__t=reason)?"":__t)+"</span>\n</div>";return __p},this.inventingOnPrinciple.Templates.lineinfo=function(obj){obj||(obj={});var __t,__p="";with(_.escape,obj)__p+='<span class="lineinfo">'+(null==(__t=msg)?"":__t)+"</span>";return __p},this.inventingOnPrinciple.Templates.slider=function(obj){obj||(obj={});var __p="";with(_.escape,obj)__p+='<div id="slider" class="span6"></div>';return __p},this.inventingOnPrinciple.Templates.spacer=function(obj){obj||(obj={});var __p="";with(_.escape,obj)__p+='<div class="spacer"></div>';return __p},this.inventingOnPrinciple.Templates.tab=function(obj){obj||(obj={});var __p="";with(_.escape,Array.prototype.join,obj)for(var i=0,l=2*(arguments[0]-1)-1;l>i;i++)__p+="&nbsp;";return __p},this.inventingOnPrinciple.Templates.tangleSpan=function(obj){obj||(obj={});var __t,__p="";with(_.escape,Array.prototype.join,obj)__p+='<span data-container="'+(null==(__t=id)?"":__t)+'">\n  <span data-var="'+(null==(__t=label)?"":__t)+'" class="TKAdjustableNumber" ',arguments[0].min&&(__p+='data-min="'+(null==(__t=min)?"":__t)+'"'),__p+=" ",arguments[0].max&&(__p+='data-max="'+(null==(__t=max)?"":__t)+'"'),__p+=" ></span>\n</span>";return __p},this.inventingOnPrinciple.Templates.tokens=function(obj){obj||(obj={});var __t,__p="";with(_.escape,Array.prototype.join,obj){__p+='<ul class="unstyled">\n    ';var map={Numeric:"cm-number",Identifier:"cm-def",Keyword:"cm-keyword"};__p+="\n    ",_.each(tokens,function(e){__p+='\n      <li>\n        <span class="cm-keyword">'+(null==(__t=e.type)?"":__t)+'</span>\n        <span class="'+(null==(__t=map[e.type]||"")?"":__t)+'">'+(null==(__t=e.value)?"":__t)+"</span>\n      </li>\n    "}),__p+="\n</ul>"}return __p},this.inventingOnPrinciple.Templates.varHint=function(obj){obj||(obj={});var __t,__p="";with(_.escape,Array.prototype.join,obj)__p+='<div class="var-hint',show||(__p+=" hidden"),__p+='">\n    <pre class="var-hint-values">'+(null==(__t=vals)?"":__t)+"</pre>\n</div>";return __p},this.inventingOnPrinciple.Templates.variable=function(obj){obj||(obj={});var __t,__p="";with(_.escape,Array.prototype.join,obj){var ctx=arguments[0];__p+="\n"+(null==(__t=inventingOnPrinciple.getTemplate("tab")(ctx.depth))?"":__t)+'\n<span class="cm-variable-2">'+(null==(__t=ctx.name)?"":__t)+" : </span>\n",__p+="Identifier"==ctx.type?'\n<span class="cm-variable-2">'+(null==(__t=ctx.value)?"":__t)+"</span>\n":"undefined"==ctx.type?'\n<span class="cm-atom">'+(null==(__t=ctx.value)?"":__t)+"</span>\n":"Literal"==ctx.type?'\n<span class="cm-number">'+(null==(__t=inventingOnPrinciple.getTemplate("tangleSpan")({id:ctx.id,label:ctx.name,value:ctx.value}))?"":__t)+"</span>\n":'\n<span class="cm-variable-2">'+(null==(__t=ctx.value)?"":__t)+"</span>\n"}return __p},function(){inventingOnPrinciple.Models.VariableModel=Backbone.Model.extend({idAttribute:"vid",setVar:function(e){var t;return t=this.get("init"),null!=t&&t.value!==e?(t.value=e,t.updateSource(e),this.trigger("change:var")):void 0},toTemplateContext:function(){var e,t;return e=this.get("init"),{id:this.cid,depth:this.get("depth"),name:this.get("id").name,loc:this.get("loc"),type:null!=(t=e&&e.type)?t:"undefined",node:this.toJSON(),value:function(){if(null==e)return"undefined";switch(e.type){case Syntax.Identifier:return e.name;case Syntax.Literal:return e.value;default:return e.source()}}()}}})}.call(this),function(){inventingOnPrinciple.Collections.VariableCollection=Backbone.Collection.extend({model:inventingOnPrinciple.Models.VariableModel,toVars:function(){return _.flatten(this.invoke("toDeclarations"))}})}.call(this),function(){inventingOnPrinciple.Views.VariableView=Backbone.View.extend({template:inventingOnPrinciple.getTemplate("variable"),tagName:"span",className:"varDec",events:{mouseup:"onMouseUp"},onMouseUp:function(){return this.model.trigger("endChange")},initTangle:function(){var e,t,n,r;return t=this.model,r=t.toTemplateContext(),e={},n=r.name,e[n]=r.value,r.type===Syntax.Literal?window.genTangle("span[data-container="+t.cid+"]",e,function(){return t.setVar(this[n])}):void 0},render:function(){return this.$el.html(this.template(this.model.toTemplateContext())),this},renderText:function(){var e;return e=this.model.toTemplateContext(),e.type===Syntax.Literal&&isNaN(+e.value)?""+e.name+' = "'+e.value+'"':""+e.name+" = "+e.value}})}.call(this),function(){inventingOnPrinciple.Models.FunctionModel=Backbone.Model.extend({idAttribute:"fid"})}.call(this),function(){inventingOnPrinciple.Collections.FunctionCollection=Backbone.Collection.extend({model:inventingOnPrinciple.Models.FunctionModel})}.call(this),function(){var e={}.hasOwnProperty;inventingOnPrinciple.Views.FunctionView=Backbone.View.extend({tagName:"div",className:"funDecs",template:inventingOnPrinciple.getTemplate("function"),render:function(){return this.$el.html(this.template(this.model.toJSON())),this},renderText:function(){var t,n,r,i;return t=this.model.toJSON(),i=function(){var i,o;i=t.params,o=[];for(n in i)e.call(i,n)&&(r=i[n],o.push(r.name));return o}().join(", "),"function "+t.id.name+" ( "+i+" )"}})}.call(this),function(){inventingOnPrinciple.Views.StateView=Backbone.View.extend({initialize:function(){var e,t=this;return this.lines=[],this.markers=[],e=this.$el.find("#state").get(0),this.editor=CodeMirror.fromTextArea(e,{mode:"javascript",lineNumbers:!0,onCursorActivity:function(){return t.onCursor()},onUpdate:function(){return t.onUpdate()},onChange:function(){return t.onChange()}})},events:{mousedown:"onMouseDown",mousemove:"onMouseMove",mouseup:"onMouseUp",touchstart:"onMouseDown",touchmove:"onMouseMove",touchend:"onMouseUp",touchcancel:"onMouseUp",keydown:"onKeyDown",keyup:"onKeyUp"},onKeyDown:function(e){var t;return(t=e.keyCode)===Keys.Alt||t===Keys.LeftSuper||t===Keys.RightSuper?this.controlPressed=!0:void 0},onKeyUp:function(e){var t;return(t=e.keyCode)===Keys.Alt||t===Keys.LeftSuper||t===Keys.RightSuper?this.controlPressed=!1:void 0},onMouseDown:function(e){return this.controlPressed?(e.stopPropagation(),this.mouseDown=!0,this.prevMouse={x:e.pageX,y:e.pageY}):void 0},onMouseMove:function(e){return this.controlPressed?(e.stopPropagation(),this.mouseDown?console.log(e.pageX-this.prevMouse.x,e.pageY-this.prevMouse.y):void 0):void 0},onMouseUp:function(e){return this.controlPressed?(e.stopPropagation(),this.mouseDown=!1,this.prevMouse=null):void 0},onCursor:function(){var e,t,n,r;return e=this.editor.getCursor(),r=this.editor.getTokenAt(e),n=this.editor.getStateAfter(e.line),this.clearMarkers(),t=this.editor.markText(util.toLoc(e.line,r.start),util.toLoc(e.line,r.end),"tangle"),this.markers.push(t)},onUpdate:function(){},onChange:function(){},setLines:function(e){return _.isEqual(this.lines,e)?void 0:(this.lines=e,this.render())},clearMarkers:function(){return _.invoke(this.markers,"clear"),this.markers=[]},scrollTo:function(e){return this.editor.scrollTo(e.x,e.y)},render:function(){var e,t,n,r,i,o,a,s,l;return a=[],e=function(){var e,u,c,f,h,p;for(h=this.lines,p=[],r=e=0,c=h.length;c>e;r=++e)if(i=h[r],null!=i){for(o=[],u=0,f=i.length;f>u;u++)l=i[u],o.push(l.renderText().replace(/[\s\n\r\t]+/g," ")),n={line:r,ch:o.join(", ").length},l.model.get("type")===Syntax.VariableDeclarator&&(t=l.model.toTemplateContext(),t.type!==Syntax.Literal||isNaN(+t.value)||(s=t.value+"",a.push({start:{line:r,ch:n.ch-s.length},end:n,model:l.model})));p.push(o.join(", "))}else p.push("");return p}.call(this),this.editor.setValue(e.join("\n"))}})}.call(this),function(){var e={}.hasOwnProperty;inventingOnPrinciple.Views.ApplicationView=Backbone.View.extend({spacer:inventingOnPrinciple.getTemplate("spacer")(),initialize:function(){return this.$code=$("#code"),this.$comment=$("#comment"),this.$loc=$("#loc"),this.$range=$("#range"),this.$raw=$("#raw"),this.$tokens=$("#tokens"),this.$syntax=$("#syntax"),this.$url=$("#url"),this.$vars=$("#vars"),this.$syntaxTab=$("#tab_syntax"),this.$tokensTab=$("#tab_tokens"),this.$urlTab=$("#tab_url"),this.$codeTab=$("#tab_code"),this.$stateTab=$("#tab_state"),this.$slider=$("#slidercontainer"),this.highlightedLines=[],this.showHints=!1,this.model.on("change:text",this.renderUrl,this).on("change:tokens",this.renderTokens,this).on("change:ast",this.renderSyntax,this).on("change:decs",this.renderDeclarations,this).on("change:generatedCode",this.renderGeneratedCode,this).on("tracedFunctions",this.renderFunctionTraces,this).on("tracedStatements",this.renderStatementTraces,this).on("tracedVars",this.renderVarsTraces,this).on("reparse",this.parse,this),this.model.on("error",this.renderError,this)},events:{"change #showvars":"toggleVars"},toggleVars:function(e){var t,n;return n=$(e.target).prop("checked"),t=this.$(".var-hint"),n?t.removeClass("hidden").slideDown("fast"):t.slideUp("fast",function(){return $(this).addClass("hidden")}),this.showHints=n},clearConsole:function(){return $("#console").html("")},markers:[],clearMarkers:function(){return _.invoke(this.markers,"clear"),this.markers=[]},widgets:[],clearWidgets:function(){var e,t,n,r;for(r=this.widgets,t=0,n=r.length;n>t;t++)e=r[t],inventingOnPrinciple.codeEditor.removeLineWidget(e);return this.widgets=[]},addWidget:function(e,t){return this.widgets.push(inventingOnPrinciple.codeEditor.addLineWidget(e,t,{coverGutter:!1,noHScroll:!0}))},trackCursor:function(t){var n,r,i,o,a,s,l,u;n=t.getCursor(),r=t.indexFromPos(n),this.clearMarkers(),l=this.model.trackCursor(n,r),u=[];for(s in l)e.call(l,s)&&(a=l[s],u.push(function(){var e,n,r;for(r=[],e=0,n=a.length;n>e;e++)i=a[e],o=t.markText(util.convertLoc(i.start),util.convertLoc(i.end),s),r.push(this.markers.push(o));return r}.call(this)));return u},parse:function(e){var t;return null==e&&(e=inventingOnPrinciple.codeEditor),t=null!=e?e.getValue():this.$code.val(),this.clearWidgets(),this.model.parse(t,e)},renderUrl:function(){return this.$url.val("#{location.protocol}//#{location.host}#{location.pathname}?code=#{encodeURIComponent(@model.text())}")},renderTokens:function(){var e;return e=_.map(this.model.tokens(),function(e){return{type:e.type,value:e.value}}),this.$tokens.html(inventingOnPrinciple.getTemplate("tokens")({tokens:e}))},renderSyntax:function(){return this.$syntax.html(this.model.astString())},renderGeneratedCode:function(){},renderDeclarations:function(){var e,t,n=this;return this.$vars.empty(),t=[],e=void 0,this.model.get("vars").each(function(n){var r;return e=n.get("loc").start.line-1,r=new inventingOnPrinciple.Views.VariableView({model:n}),null!=t[e]?t[e].push(r):t[e]=[r]}),this.model.get("funs").each(function(n){var r;return e=n.get("loc").start.line-1,r=new inventingOnPrinciple.Views.FunctionView({model:n}),null!=t[e]?t[e].push(r):t[e]=[r]}),_.each(t,function(e){var t,r,i,o,a,s,l;if(e){for(t=$('<div class="varDecs"></div>'),i=0,a=e.length;a>i;i++)r=e[i],t.append(r.render().$el);for(n.$vars.append(t),l=[],o=0,s=e.length;s>o;o++)r=e[o],r.initTangle?l.push(r.initTangle()):l.push(void 0);return l}return n.$vars.append(n.spacer)})},renderFunctionTraces:function(e,t){var n,r,i;return r=inventingOnPrinciple.Options.max,i={},_.each(e,function(e,t){return i[t]=e/r}),n=this.$("#vars").children(),n.css("background-color","transparent"),_.each(t.reverse(),function(t){var r,o,a,s,l,u,c;return u=t.loc.start.line-1,l=t.loc.end.line-1,c=i[t.name],s=e[t.name],a="rgba(255, 0, 0, "+util.mapValue(c,.05,.9)+")",r=inventingOnPrinciple.getTemplate("lineinfo")({msg:s}),o=n.slice(u,l),o.css({"background-color":a}),o.find(".lineinfo").remove().end().append(r)}),this},highlightLines:function(e,t){var n,r,i,o,a,s,l,u,c;for(o="background",n="highlight-line",i=_.range(e,t+1),c=this.highlightedLines,a=0,l=c.length;l>a;a++)r=c[a],inventingOnPrinciple.codeEditor.removeLineClass(r,o,n);for(s=0,u=i.length;u>s;s++)r=i[s],inventingOnPrinciple.codeEditor.addLineClass(r,o,n);return this.highlightedLines=i},renderStatementTraces:function(e){var t,n,r,i=this;return n=_.pluck(e,"loc"),r=0,t=n.length-1,t>0?(this.$slider.children().remove().end().append(inventingOnPrinciple.getTemplate("slider")()).find("#slider").slider({min:r,max:t,value:t}).on("slide",function(t){var n,o;return o=e[t.value-r],n=o.loc,i.highlightLines(n.start.line-1,n.end.line-1),i.clearWidgets(),i.renderVarsTraces(o)}),this.renderVarsTraces(e[t])):void 0},renderVarsTraces:function(t){var n,r,i,o,a,s,l,u,c,f,h;h=tracer.indexMapToVarDict(t.vars),c=t.varLocs;for(o in c)e.call(c,o)&&(s=c[o],u=util.objGet(h,o),r=util.formatVal(u,util.unscopeName(s)),a=+util.unscopeName(o),f=$(inventingOnPrinciple.getTemplate("varHint")({vals:r,show:this.showHints})).get(0),_.isArray(u)&&(l=_.map(u,function(e,t){return[t,e]}),("insertionSort.list.all"===o||"insert.array.all"===o)&&window.updateD3(l)));return CodeMirror.runMode(util.printJSON(h),{name:"javascript",json:!0},document.getElementById("varsPre")),i=inventingOnPrinciple.codeEditor.getScrollInfo(),n=inventingOnPrinciple.codeEditor.charCoords({line:inventingOnPrinciple.codeEditor.getCursor().line+1,ch:0},"local").top,n>i.top+i.clientHeight?inventingOnPrinciple.codeEditor.scrollTo(null,n-i.clientHeight+3):void 0},renderError:function(e){var t,n,r;return t=e.lineNumber?e.lineNumber-1:inventingOnPrinciple.codeEditor.getCursor().line,null==(r=e.reason)&&(e.reason=e.message),n=$(inventingOnPrinciple.getTemplate("hint")(e)).get(0),this.addWidget(t,n)},scrollVars:function(e){return this.$("#decsContainer").scrollTop(e.y)},render:function(){return this.renderUrl(),this.renderTokens(),this.renderSyntax(),this.renderGeneratedCode(),this.renderDeclarations()}})}.call(this),function(){inventingOnPrinciple.Models.ApplicationModel=Backbone.Model.extend({defaults:{parsingOptions:{range:!0,loc:!0,raw:!0,tokens:!0}},initialize:function(e,t){var n,r,i=this;return null!=e&&null!=e.text&&this.setSource(e.text,t),r=new inventingOnPrinciple.Collections.VariableCollection,n=new inventingOnPrinciple.Collections.FunctionCollection,this.set({vars:r,funs:n},{silent:!0}),r.on("change:var",function(){return inventingOnPrinciple.updating=!0,inventingOnPrinciple.codeEditor.setValue(i.source()),inventingOnPrinciple.updating=!1,i.instrumentFunctions()}).on("endChange",function(){return i.trigger("reparse")}),this.on("change:ast",this.onASTChange,this)},setSource:function(e,t){var n,r,i,o;if("string"==typeof e)return i=esprima.parse(e,this.get("parsingOptions")),o=i.tokens,n=_.omit(i,"tokens"),r=e.split(""),this.set({ast:n,astText:util.printJSON(n),chunks:r,tokens:o},_.extend(t,{silent:!0})),this.posttraverse(util.insertHelpers),this},traverse:function(e,t,n){var r;return null==n&&(n=this.get("ast")),r=this.get("chunks"),null!=n&&null!=r?util.traverse.call(this,n,r,e,t):void 0},pretraverse:function(e,t){return this.traverse(e,null,t)},posttraverse:function(e,t){return this.traverse(null,e,t)},extractFunction:function(e,t){var n,r;return r=e.parent,n="",e.type===Syntax.FunctionDeclaration?n=e.id.name:e.type===Syntax.FunctionExpression&&(r.type===Syntax.AssignmentExpression&&null!=r.left.range?n=code.slice(r.left.range[0],r.left.range[1]+1):r.type===Syntax.VariableDeclarator?n=r.id.name:r.type===Syntax.CallExpression?n=r.id?r.id.name:"[Anonymous]":"number"==typeof r.length?n=r.id?r.id.name:"[Anonymous]":null!=r.key&&r.key.type===Syntax.Identifier&&r.value===e&&r.key.name&&(n=r.key.name)),null!=n&&n.length?t.push(_.extend(e,{name:n})):void 0},instrumentFunctions:function(){var e,t,n,r,i,o,a,s,l,u,c,f=this;for(l=[],this.pretraverse(function(e){var t;return f.extractFunction(e,l),(t=e.type)===Syntax.ForStatement||t===Syntax.ForInStatement||t===Syntax.ExpressionStatement||t===Syntax.VariableDeclaration||t===Syntax.ReturnStatement?l.push(e):void 0}),t=this.get("chunks"),n=_.clone(t),window.tracer.genTraces(l,this.scopes),s=this.source(),o=u=0,c=n.length;c>u;o=++u)e=n[o],t[o]=n[o];return window.tracer.active=!0,inventingOnPrinciple.view.clearConsole(),s.length&&eval.call({_:_},s),i=window.tracer.funcHistogram(),r=_.filter(l,function(e){var t;return(t=e.type)===Syntax.FunctionExpression||t===Syntax.FunctionDeclaration}),this.trigger("tracedFunctions",i,r),a=window.tracer.getStatementList(),this.trigger("tracedStatements",a),window.tracer.active=!1,this},extractDeclarations:function(){var e,t,n,r;return e=this.get("ast"),n={},r=[],t=[],this.pretraverse(function(e){var n;return e.type===Syntax.VariableDeclarator?(n=new inventingOnPrinciple.Models.VariableModel(e),r.push(n)):e.type===Syntax.FunctionDeclaration?(n=new inventingOnPrinciple.Models.FunctionModel(e),t.push(e)):void 0}),this.get("vars").reset(r),this.get("funs").reset(t),this.trigger("change:decs",r,t),this},buildScope:function(){var e;return e=this.get("ast"),this.scopes={global:{name:"global",node:e,vars:[],funcs:[]}},this.posttraverse(function(e){var t,n;switch(t=util.scopeLookup(e,this.scopes),e.type){case Syntax.VariableDeclarator:return t.vars.push(e.id.name);case Syntax.FunctionDeclaration:return n=util.scopeName(e.id.name,t),t.funcs.push(n),this.scopes[n]={name:n,node:e,parent:t,vars:["arguments"],funcs:[]}}}),this},onASTChange:function(){var e;try{return e=window.escodegen.generate(this.get("ast")),this.set({generatedCode:e})}catch(t){return console.log("gen Error",t)}},trackCursor:function(e,t){var n,r;return r={indentifier:[],highlight:[]},n=null,this.pretraverse(function(e){return null!=e&&e.type===Syntax.Identifier&&util.withinRange(t,e.range)?(r.indentifier.push(e.loc),n=e):void 0}),null!=n&&this.pretraverse(function(e){return null!=e&&e.type===Syntax.Identifier&&e!==n&&e.name===n.name?r.highlight.push(e.loc):void 0}),r},updateHints:function(e){var t,n=this;return t=!1,e.operation(function(){var r,i,o,a,s;for(JSHINT(e.getValue()),a=JSHINT.errors,s=[],i=0,o=a.length;o>i;i++)r=a[i],null!=r&&(n.trigger("error",r),s.push(t=!0));return s}),t},parse:function(e,t){if(!inventingOnPrinciple.updating&&!this.updateHints(t))try{return this.setSource(e),"function"==typeof this.extractDeclarations&&this.extractDeclarations(),"function"==typeof this.buildScope&&this.buildScope(),"function"==typeof this.instrumentFunctions?this.instrumentFunctions():void 0}catch(n){return this.trigger("error",n)}},tokens:function(){return this.get("tokens")},generatedCode:function(){return this.get("generatedCode")},astString:function(){return this.get("astText")},source:function(){var e;return"function"==typeof(e=this.get("ast")).source?e.source():void 0}})}.call(this),function(){inventingOnPrinciple.Routers.ApplicationRouter=Backbone.Router.extend}.call(this);